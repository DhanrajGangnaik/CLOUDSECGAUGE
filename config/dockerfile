# Use an official build environment with essential tools
FROM ubuntu:20.04 as builder

ENV DEBIAN_FRONTEND=noninteractive

# Install required dependencies and tools
RUN apt-get update && apt-get install -y \
    python3 python3-pip wget curl build-essential \
    gawk bison libgcc-9-dev libc-dev

# Download and build glibc-2.29
RUN wget http://ftp.gnu.org/gnu/libc/glibc-2.29.tar.gz && \
    tar -xvzf glibc-2.29.tar.gz && \
    cd glibc-2.29 && \
    mkdir build && cd build && \
    ../configure --prefix=/usr && \
    make -j$(nproc) && \
    make install

# Create final stage with Oracle image and Python setup
FROM gvenzl/oracle-xe:latest

# Copy Python and pip from builder stage
COPY --from=builder /usr/bin/python3 /usr/bin/python3
COPY --from=builder /usr/bin/pip3 /usr/bin/pip3

# Set working directory in the container
WORKDIR /app

# Copy project files to the container
COPY . /app

# Install required Python packages
RUN pip3 install -r requirements.txt

# Expose the Flask app port
EXPOSE 5000

# Run the Flask app
CMD ["python3", "app.py"]